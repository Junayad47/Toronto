<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jay's Toronto Guide - Perfect Day Trip</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: calc(100vh - 40px);
        }
        /* Tablet */
        .navigation-panel {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 15px 25px;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
            max-width: 90%;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { bottom: -100px; opacity: 0; }
            to { bottom: 20px; opacity: 1; }
        }
        .navigation-panel.active {
            display: block;
        }
        .nav-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .nav-icon {
            font-size: 32px;
            animation: pulse-icon 2s infinite;
        }
        @keyframes pulse-icon {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .nav-info {
            flex: 1;
        }
        .nav-distance {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            margin: 0;
        }
        .nav-time {
            font-size: 14px;
            color: #666;
            margin: 5px 0 0 0;
        }
        .nav-buttons {
            display: flex;
            gap: 10px;
        }
        .nav-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .nav-btn:hover {
            transform: scale(1.05);
        }
        .nav-btn.stop {
            background: linear-gradient(135deg, #e53935, #c62828);
        }
        .location-controls {
            position: fixed;
            bottom: 120px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .location-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s ease;
        }
        .location-btn:hover {
            transform: scale(1.1);
        }
        .location-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        .weather-widget {
            position: fixed;
            top: 80px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            min-width: 150px;
            display: none;
        }
        .weather-widget.show {
            display: block;
        }
        .photo-gallery {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            margin: 15px 0;
            padding: 5px 0;
        }
        .photo-thumb {
            width: 100px;
            height: 100px;
            border-radius: 8px;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.3s ease;
            flex-shrink: 0;
        }
        .photo-thumb:hover {
            transform: scale(1.05);
        }
        .direction-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            pointer-events: none;
            z-index: 500;
            display: none;
        }
        .direction-indicator.active {
            display: block;
        }
        .direction-arrow {
            width: 100%;
            height: 100%;
            background: rgba(102, 126, 234, 0.9);
            clip-path: polygon(50% 0%, 100% 100%, 50% 80%, 0% 100%);
            transition: transform 0.3s ease;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.5);
        }
        .nearby-panel {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .nearby-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .nearby-item:hover {
            background: #e7f3ff;
            transform: translateX(5px);
        }
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 2000;
            display: none;
            animation: toastSlide 0.3s ease;
        }
        @keyframes toastSlide {
            from { top: -100px; }
            to { top: 20px; }
        }
        .toast.show {
            display: block;
        }
        @media (max-width: 768px) {
            .navigation-panel {
                bottom: 10px;
                padding: 12px 15px;
                max-width: 95%;
            }
            .nav-content {
                flex-direction: column;
                gap: 10px;
            }
            .nav-buttons {
                width: 100%;
            }
            .nav-btn {
                flex: 1;
                padding: 12px;
            }
            .location-controls {
                bottom: 90px;
                right: 10px;
            }
            .location-btn {
                width: 45px;
                height: 45px;
                font-size: 20px;
            }
            .weather-widget {
                top: 70px;
                right: 10px;
                font-size: 12px;
                min-width: 120px;
                padding: 10px;
            }
        }
        .route-options {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #4caf50;
        }
        .route-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .route-option:hover {
            background: #e8f5e9;
            transform: translateX(5px);
        }
        .route-option.selected {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 2px solid #667eea;
        }
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .action-btn {
            flex: 1;
            min-width: 150px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        .action-btn:active {
            transform: translateY(0);
        }
        .progress-tracker {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .progress-bar-container {
            background: #e0e0e0;
            height: 10px;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }
        .progress-bar {
            background: linear-gradient(135deg, #667eea, #764ba2);
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }
        .checkpoint {
            display: inline-block;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #e0e0e0;
            margin: 0 5px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .checkpoint.completed {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        @media (max-width: 768px) {
            .action-buttons {
                flex-direction: column;
            }
            .action-btn {
                min-width: 100%;
            }
        }
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .info-section h3 {
            color: #667eea;
            margin: 0 0 15px 0;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 10px;
        }
        .info-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
        }
        .info-item strong {
            display: block;
            color: #667eea;
            margin-bottom: 5px;
        }
        .maps-button {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 13px;
            font-weight: 600;
            margin: 8px 8px 0 0;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .maps-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .maps-button:active {
            transform: translateY(0);
        }
        @media (max-width: 768px) {
            .info-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .info-section {
                padding: 15px;
                margin-bottom: 12px;
            }
            .info-section h3 {
                font-size: 16px;
            }
            .info-item {
                padding: 10px;
                font-size: 13px;
            }
            .maps-button {
                display: block;
                text-align: center;
                margin: 8px 0 0 0;
            }
        }
            .container { 
                grid-template-columns: 1fr; 
                height: auto; 
                gap: 15px;
            }
            #map { 
                height: 500px !important; 
                order: -1; 
                margin-bottom: 15px;
            }
            .itinerary-panel {
                padding: 25px;
            }
            h1 { font-size: 26px; }
        }

        /* Mobile Large (landscape phones) */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { 
                gap: 10px;
                height: auto;
            }
            #map { 
                height: 400px !important; 
                border-radius: 15px;
            }
            .itinerary-panel {
                padding: 20px;
                border-radius: 15px;
            }
            h1 { font-size: 24px; }
            .summary-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .summary-item {
                padding: 10px;
            }
            .step {
                padding: 18px;
                margin-bottom: 15px;
            }
            .step h3 { font-size: 18px; }
            .step-number {
                width: 36px;
                height: 36px;
                font-size: 16px;
                top: -8px;
                left: 15px;
            }
            .step-time {
                font-size: 12px;
                padding: 3px 10px;
                margin-left: 25px;
            }
            .duration, .cost {
                font-size: 12px;
                padding: 5px 10px;
            }
            .alert, .tip, .transit, .food-stop {
                font-size: 13px;
                padding: 10px;
            }
        }

        /* Mobile Small (portrait phones) */
        @media (max-width: 480px) {
            body { padding: 5px; }
            .container {
                gap: 8px;
            }
            #map { 
                height: 350px !important; 
                border-radius: 12px;
            }
            .itinerary-panel {
                padding: 15px;
                border-radius: 12px;
            }
            h1 { 
                font-size: 22px;
                margin-bottom: 8px;
            }
            .date-badge {
                font-size: 12px;
                padding: 6px 12px;
                margin-bottom: 15px;
            }
            .summary {
                padding: 15px;
            }
            .summary h2 { 
                font-size: 18px;
                margin-bottom: 12px;
            }
            .summary-grid {
                gap: 8px;
            }
            .summary-item {
                padding: 8px;
                font-size: 13px;
            }
            .step {
                padding: 15px;
                padding-top: 20px;
                margin-bottom: 12px;
                border-radius: 10px;
            }
            .step h3 { 
                font-size: 16px;
                margin: 10px 0 8px 0;
            }
            .step-number {
                width: 32px;
                height: 32px;
                font-size: 14px;
                top: -6px;
                left: 12px;
            }
            .step-time {
                font-size: 11px;
                padding: 3px 8px;
                margin-left: 20px;
                display: block;
                width: fit-content;
            }
            .step-details {
                font-size: 14px;
                line-height: 1.6;
            }
            .duration, .cost {
                font-size: 11px;
                padding: 4px 8px;
                margin: 6px 4px 6px 0;
                display: inline-block;
            }
            .alert, .tip, .transit, .food-stop {
                font-size: 12px;
                padding: 8px;
                margin: 8px 0;
                line-height: 1.5;
            }
            .alert strong, .tip strong, .food-stop strong {
                font-size: 13px;
            }
            .highlight {
                font-size: 12px;
                padding: 2px 4px;
            }
            .map-legend {
                padding: 10px;
                font-size: 11px;
                max-width: 200px;
            }
            .map-legend h4 {
                font-size: 13px;
                margin-bottom: 8px;
            }
            .legend-item {
                margin: 3px 0;
            }
            .legend-icon {
                width: 20px;
                height: 20px;
                font-size: 10px;
                margin-right: 8px;
            }
            .legend-line {
                width: 25px;
                height: 2px;
                margin-right: 8px;
            }
        }

        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            .step {
                cursor: pointer;
                -webkit-tap-highlight-color: rgba(102, 126, 234, 0.1);
            }
            .step:active {
                transform: scale(0.98);
                background: #f0f0f0;
            }
            /* Larger touch targets for map controls */
            .leaflet-control-zoom a {
                width: 40px !important;
                height: 40px !important;
                line-height: 40px !important;
                font-size: 20px !important;
            }
            /* Make popups easier to close on touch */
            .leaflet-popup-close-button {
                width: 30px !important;
                height: 30px !important;
                font-size: 24px !important;
            }
        }

        /* Very small screens (older phones) */
        @media (max-width: 360px) {
            h1 { font-size: 20px; }
            .step h3 { font-size: 15px; }
            #map { height: 300px !important; }
            .summary h2 { font-size: 16px; }
        }
        .itinerary-panel {
            background: white;
            border-radius: 20px;
            padding: 30px;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        #map {
            height: 100%;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
        }
        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 28px;
        }
        .date-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        .alert {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-size: 14px;
        }
        .alert strong { color: #856404; }
        .step {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .step:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
        }
        .step-number {
            position: absolute;
            top: -10px;
            left: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .step-time {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 10px;
            margin-left: 30px;
        }
        .step h3 {
            color: #2c3e50;
            margin: 15px 0 10px 0;
            font-size: 20px;
        }
        .step-details {
            margin-top: 12px;
            line-height: 1.8;
        }
        .icon { margin-right: 8px; }
        .duration {
            background: #e7f3ff;
            color: #0066cc;
            padding: 6px 12px;
            border-radius: 8px;
            display: inline-block;
            font-size: 13px;
            font-weight: 600;
            margin: 8px 0;
        }
        .cost {
            background: #fff0e6;
            color: #ff6b35;
            padding: 6px 12px;
            border-radius: 8px;
            display: inline-block;
            font-size: 13px;
            font-weight: 600;
            margin: 8px 8px 8px 0;
        }
        .transit {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
            border-left: 3px solid #4caf50;
        }
        .food-stop {
            background: #fff3e0;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 3px solid #ff9800;
        }
        .tip {
            background: #f3e5f5;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 3px solid #9c27b0;
            font-size: 14px;
        }
        .highlight {
            background: #ffeb3b;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        .summary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .summary h2 { margin-bottom: 15px; font-size: 20px; }
        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .summary-item {
            background: rgba(255,255,255,0.2);
            padding: 12px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }
        .summary-item strong { display: block; margin-bottom: 5px; }
        
        /* Enhanced Map Styles */
        .custom-popup .leaflet-popup-content-wrapper {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 12px;
            padding: 5px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        .custom-popup .leaflet-popup-content {
            margin: 15px;
            font-size: 14px;
            line-height: 1.6;
        }
        .custom-popup .leaflet-popup-tip {
            background: #667eea;
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .map-legend {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 13px;
            line-height: 2;
        }
        .map-legend h4 {
            margin: 0 0 10px 0;
            font-size: 15px;
            font-weight: bold;
            color: #667eea;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        .legend-line {
            width: 30px;
            height: 3px;
            margin-right: 10px;
            border-radius: 2px;
        }
        .legend-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: white;
            font-weight: bold;
        }
        @media print {
            body { background: white; padding: 0; }
            .container { 
                display: block; 
                max-width: 100%;
            }
            #map { display: none; }
            .itinerary-panel {
                box-shadow: none;
                border-radius: 0;
            }
            .step {
                break-inside: avoid;
                page-break-inside: avoid;
            }
            .date-badge, .summary {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="itinerary-panel">
            <h1>🍁 Jay's Toronto Guide</h1>
            <div class="date-badge">🎯 The Ultimate One-Day Adventure</div>
            
            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="action-btn" onclick="shareGuide()">📤 Share Guide</button>
                <button class="action-btn" onclick="window.print()">🖨️ Print/Save PDF</button>
                <button class="action-btn" onclick="startQuickTour()">⚡ Quick Tour Mode</button>
            </div>

            <!-- Progress Tracker -->
            <div class="progress-tracker">
                <h3 style="margin: 0 0 10px 0; color: #667eea; font-size: 16px;">📍 Track Your Progress</h3>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span id="progress-text" style="font-size: 14px; color: #666;">0 of 10 stops completed</span>
                    <span id="progress-percent" style="font-size: 14px; font-weight: bold; color: #667eea;">0%</span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
                <div style="text-align: center; margin-top: 10px;">
                    <span class="checkpoint" data-stop="1" onclick="toggleCheckpoint(1)"></span>
                    <span class="checkpoint" data-stop="2" onclick="toggleCheckpoint(2)"></span>
                    <span class="checkpoint" data-stop="3" onclick="toggleCheckpoint(3)"></span>
                    <span class="checkpoint" data-stop="4" onclick="toggleCheckpoint(4)"></span>
                    <span class="checkpoint" data-stop="5" onclick="toggleCheckpoint(5)"></span>
                    <span class="checkpoint" data-stop="6" onclick="toggleCheckpoint(6)"></span>
                    <span class="checkpoint" data-stop="7" onclick="toggleCheckpoint(7)"></span>
                    <span class="checkpoint" data-stop="8" onclick="toggleCheckpoint(8)"></span>
                    <span class="checkpoint" data-stop="9" onclick="toggleCheckpoint(9)"></span>
                    <span class="checkpoint" data-stop="10" onclick="toggleCheckpoint(10)"></span>
                </div>
                <p style="font-size: 12px; color: #888; margin-top: 10px; text-align: center;">Tap circles to mark stops as completed</p>
            </div>

            <!-- Real-time Navigation Quick Start -->
            <div class="info-section" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1)); border-left-color: #4caf50;">
                <h3>🧭 Real-Time Navigation - Quick Start</h3>
                <div style="font-size: 14px; line-height: 1.8;">
                    <strong>🚀 NEW FEATURES:</strong><br>
                    1️⃣ Tap <strong>📍 button</strong> (bottom right) to enable location tracking<br>
                    2️⃣ Click <strong>🧭 Navigate</strong> on any stop to start turn-by-turn directions<br>
                    3️⃣ Live distance & walking time updates as you move<br>
                    4️⃣ Auto-complete when you arrive at each location<br>
                    5️⃣ Use <strong>🔍 button</strong> to find nearby restrooms, ATMs, cafes<br>
                    6️⃣ Check <strong>🌤️ button</strong> for current weather<br>
                    7️⃣ Enable <strong>🧭 AR Compass</strong> for visual direction arrow<br><br>
                    <strong>💡 Works offline once loaded!</strong> Your phone's GPS works without data.
                </div>
            </div>
            
            <div class="alert">
                <strong>💡 Before You Go:</strong><br>
                • Check attraction websites for <span class="highlight">current hours & prices</span><br>
                • Book tickets online in advance to <span class="highlight">skip lines</span><br>
                • ROM often has free admission days - <span class="highlight">check their calendar</span><br>
                • Distillery District hosts seasonal events year-round
            </div>

            <div class="summary">
                <h2>📊 Trip at a Glance</h2>
                <div class="summary-grid">
                    <div class="summary-item">
                        <strong>⏱️ Duration</strong>
                        8-10 hours (Full Day)
                    </div>
                    <div class="summary-item">
                        <strong>💰 Budget</strong>
                        $70-120 CAD
                    </div>
                    <div class="summary-item">
                        <strong>🚶 Total Walking</strong>
                        ~4.9 km (3 miles)
                    </div>
                    <div class="summary-item">
                        <strong>🚇 TTC Rides</strong>
                        2-3 rides (~$10 total)
                    </div>
                    <div class="summary-item">
                        <strong>🔥 Calories Burned</strong>
                        ~600-800 kcal (walking)
                    </div>
                    <div class="summary-item">
                        <strong>📸 Photo Spots</strong>
                        10+ Instagram-worthy locations
                    </div>
                    <div class="summary-item">
                        <strong>🧭 Navigation</strong>
                        Real-time GPS tracking
                    </div>
                    <div class="summary-item">
                        <strong>🌐 Connectivity</strong>
                        Works offline after loading
                    </div>
                </div>
                <div style="margin-top: 15px; padding: 12px; background: rgba(255,255,255,0.2); border-radius: 8px; font-size: 13px;">
                    <strong>💡 Pro Tip:</strong> Enable location tracking for live navigation, auto-completion, and nearby facility search!
                </div>
            </div>

            <!-- STOP 1 -->
            <div class="step" onclick="focusOnMap(1)">
                <div class="step-number">1</div>
                <div class="step-time">⏰ Start: 10:00 AM</div>
                <h3>🗼 CN Tower</h3>
                <div class="step-details">
                    <span class="duration">⏱️ 60 min</span>
                    <span class="cost">💰 $40-50 CAD</span>
                    <p><strong>📍 290 Bremner Blvd</strong></p>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin: 10px 0;">
                        <button class="maps-button" onclick="event.stopPropagation(); openInMaps(43.6426, -79.3871, 'CN Tower')">📍 Open in Maps</button>
                        <button class="maps-button" onclick="event.stopPropagation(); startNavigation(0)" style="background: linear-gradient(135deg, #4caf50, #388e3c);">🧭 Navigate</button>
                    </div>
                    
                    <!-- Photo Gallery -->
                    <div class="photo-gallery">
                        <div style="width: 100px; height: 100px; border-radius: 8px; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; color: white; font-size: 40px; flex-shrink: 0;">
                            🗼
                        </div>
                        <div style="width: 100px; height: 100px; border-radius: 8px; background: linear-gradient(135deg, #f093fb, #f5576c); display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; text-align: center; flex-shrink: 0; cursor: pointer;" onclick="event.stopPropagation(); alert('In a full version, this would show actual photos!')">
                            📸 View<br>Photos
                        </div>
                    </div>

                    <p><strong>Hours:</strong> Daily 9am-10pm (varies seasonally)</p>
                    <p>Start at Canada's iconic 553m landmark! Glass elevator to Main Observation Level (346m). Walk on the Glass Floor if you dare!</p>
                    
                    <!-- Route Options -->
                    <div class="route-options">
                        <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #4caf50;">🚶 Getting Here</h4>
                        <div class="route-option selected" onclick="event.stopPropagation()">
                            <div>
                                <strong>Walk from Hotel</strong><br>
                                <small style="color: #666;">Most hotels are 5-15 min walk</small>
                            </div>
                            <strong style="color: #4caf50;">Recommended</strong>
                        </div>
                        <div class="route-option" onclick="event.stopPropagation()">
                            <div>
                                <strong>TTC to Union</strong><br>
                                <small style="color: #666;">Then 10 min walk south</small>
                            </div>
                            <span>$3.35</span>
                        </div>
                    </div>

                    <div class="tip">
                        💡 <strong>Pro Tips:</strong> Buy tickets online to skip lines. Before 11am is least crowded. On clear days, see Niagara Falls! CityPASS saves 38% if visiting multiple attractions.
                    </div>
                </div>
            </div>

            <!-- STOP 2 -->
            <div class="step" onclick="focusOnMap(2)">
                <div class="step-number">2</div>
                <div class="step-time">⏰ 11:00 AM</div>
                <h3>🐠 Ripley's Aquarium</h3>
                <div class="step-details">
                    <span class="duration">⏱️ 60-90 min</span>
                    <span class="cost">💰 $35-45 CAD</span>
                    <p><strong>📍 288 Bremner Blvd (2 min walk)</strong></p>
                    <button class="maps-button" onclick="event.stopPropagation(); openInMaps(43.6424, -79.3860, 'Ripleys Aquarium')">📍 Open in Maps</button>
                    <p><strong>Hours:</strong> Daily 9am-9pm</p>
                    <p>20,000+ aquatic animals across 9 galleries. Dangerous Lagoon underwater tunnel is breathtaking - sharks and rays swim overhead!</p>
                    <div class="tip">
                        💡 <strong>Pro Tip:</strong> "Sea The Sky" combo with CN Tower saves money. Visit before 11am or after 4pm to avoid crowds. Touch exhibits include stingrays!
                    </div>
                </div>
            </div>

            <!-- STOP 3 -->
            <div class="step" onclick="focusOnMap(3)">
                <div class="step-number">3</div>
                <div class="step-time">⏰ 12:15 PM</div>
                <h3>🚶 Walk to Union Station</h3>
                <div class="step-details">
                    <span class="duration">⏱️ 8 min walk (600m)</span>
                    <button class="maps-button" onclick="event.stopPropagation(); openInMaps(43.6456, -79.3804, 'Union Station Toronto')">📍 Open in Maps</button>
                    <p>Head northeast on Bremner Blvd, right on York St, walk to Front St W.</p>
                    <div class="food-stop">
                        🍕 <strong>Quick Options:</strong> Union Station food court has everything from coffee to full meals. PATH underground system connects to dozens of restaurants.
                    </div>
                </div>
            </div>

            <!-- STOP 4 -->
            <div class="step" onclick="focusOnMap(4)">
                <div class="step-number">4</div>
                <div class="step-time">⏰ 12:30 PM</div>
                <h3>🥖 St. Lawrence Market</h3>
                <div class="step-details">
                    <span class="duration">⏱️ 60-90 min</span>
                    <span class="cost">💰 $15-25 lunch</span>
                    <p><strong>📍 92-95 Front St E (10 min walk, 850m)</strong></p>
                    <button class="maps-button" onclick="event.stopPropagation(); openInMaps(43.6487, -79.3715, 'St Lawrence Market')">📍 Open in Maps</button>
                    <button class="maps-button" onclick="event.stopPropagation(); getDirections(43.6424, -79.3860, 43.6487, -79.3715)">🧭 Directions from Aquarium</button>
                    <p><strong>Hours:</strong> Tue-Thu 9am-7pm, Fri 9am-7pm, Sat 7am-5pm, Sun 10am-5pm (Closed Mondays)</p>
                    <p>Walk east on Front St. World's best food market per National Geographic! Over 100 vendors.</p>
                    <div class="food-stop">
                        🥪 <strong>MUST TRY:</strong><br>
                        • <strong>Carousel Bakery</strong> - Legendary peameal bacon sandwich ($8-12)<br>
                        • <strong>Mike's Fish Market</strong> - Fresh oysters, steamed lobster (eat on-site!)<br>
                        • Artisan cheeses, international cuisine, baked goods<br>
                        • Farmers Market on Saturdays (5am-3pm)
                    </div>
                    <div class="tip">
                        💡 Lower level has unique artisan vendors and gifts. Arrive hungry!
                    </div>
                </div>
            </div>

            <!-- STOP 5 -->
            <div class="step" onclick="focusOnMap(5)">
                <div class="step-number">5</div>
                <div class="step-time">⏰ 2:00 PM</div>
                <h3>🎨 Distillery Historic District</h3>
                <div class="step-details">
                    <span class="duration">⏱️ 60-90 min</span>
                    <span class="cost">💰 FREE entry</span>
                    <p><strong>📍 55 Mill St (10 min walk, 750m)</strong></p>
                    <p><strong>Hours:</strong> Mon-Thu 10am-8pm, Fri-Sat 10am-9pm, Sun 11am-8pm</p>
                    <p>Walk south on Parliament St, then east on Mill St. Pedestrian-only Victorian industrial village with cobblestone streets, art galleries, boutiques, cafes.</p>
                    <div class="alert" style="background: #e3f2fd; border-color: #2196f3;">
                        <strong>🎉 Year-Round Events:</strong><br>
                        • Winter: Famous Christmas Market (Nov-Dec)<br>
                        • Spring/Summer: Art shows, food festivals, live music<br>
                        • Fall: Oktoberfest, Halloween festivities<br>
                        Check website for current events!
                    </div>
                    <div class="food-stop">
                        ☕ <strong>Food & Drink:</strong><br>
                        • <strong>Balzac's Coffee</strong> - Perfect afternoon pick-me-up<br>
                        • <strong>Mill Street Brewpub</strong> - Local craft beer & pub food<br>
                        • <strong>El Catrin</strong> - Mexican restaurant<br>
                        • Dozens of cafes, restaurants, chocolatiers
                    </div>
                    <div class="tip">
                        💡 Great for photos! Historic red brick buildings. Open 364 days/year.
                    </div>
                </div>
            </div>

            <!-- STOP 6 -->
            <div class="step" onclick="focusOnMap(6)">
                <div class="step-number">6</div>
                <div class="step-time">⏰ 3:30 PM</div>
                <h3>🚇 TTC to ROM</h3>
                <div class="step-details">
                    <span class="duration">⏱️ 20 min total</span>
                    <span class="cost">💰 $3.35 per ride</span>
                    <div class="transit">
                        🚊 <strong>Route:</strong><br>
                        1. Walk 5 min west to <strong>King Station</strong> (Parliament & King)<br>
                        2. Take <strong>Line 1 (Yellow) NORTHBOUND</strong><br>
                        3. Ride 5 stops (~8 min) to <strong>Museum Station</strong><br>
                        4. Exit at Museum - ROM is across the street!
                    </div>
                    <div class="tip">
                        💡 <strong>TTC Payment:</strong> PRESTO card ($6 card + funds), contactless credit/debit, or tokens. Day Pass $13.50 (unlimited rides). Keep receipt for transfers!
                    </div>
                </div>
            </div>

            <!-- STOP 7 -->
            <div class="step" onclick="focusOnMap(7)">
                <div class="step-number">7</div>
                <div class="step-time">⏰ 3:50 PM</div>
                <h3>🦕 Royal Ontario Museum (ROM)</h3>
                <div class="step-details">
                    <span class="duration">⏱️ 60-90 min</span>
                    <span class="cost">💰 $20-30 CAD (varies)</span>
                    <p><strong>📍 100 Queen's Park</strong></p>
                    <p><strong>Hours:</strong> Tue-Sun 10am-5:30pm, closed Mondays (except holidays)</p>
                    <div class="alert" style="background: #d4edda; border-color: #28a745;">
                        <strong>💰 FREE ADMISSION OPTIONS:</strong><br>
                        • Free main floor (seasonal programs - check website)<br>
                        • 3rd Tuesday Nights Free (5:30-8:30pm monthly)<br>
                        • Full-time students with Canadian ID: Free Tuesdays
                    </div>
                    <p>One of North America's largest museums! 18M+ objects: dinosaurs, mummies, Chinese architecture, Indigenous artifacts, gems & minerals, natural history.</p>
                    <div class="tip">
                        💡 <strong>Tips:</strong> Buy tickets online for "Plan Ahead Pricing" discounts. Allow 2-3 hours for full visit. ROM membership (~$75) pays for itself in 3 visits!
                    </div>
                </div>
            </div>

            <!-- STOP 8 -->
            <div class="step" onclick="focusOnMap(8)">
                <div class="step-number">8</div>
                <div class="step-time">⏰ 5:00 - 6:00 PM</div>
                <h3>🌿 Kensington Market</h3>
                <div class="step-details">
                    <span class="duration">⏱️ 60 min</span>
                    <span class="cost">💰 $10-15</span>
                    <p><strong>📍 Kensington Ave area (15 min walk, 1.2km)</strong></p>
                    <p>Walk west on Bloor, then south on Spadina, west on College. Eclectic bohemian neighborhood!</p>
                    <div class="food-stop">
                        🌮 <strong>Seven Lives Tacos</strong> - Best fish tacos in Toronto ($4-6 each)<br>
                        🧀 <strong>Global Cheese</strong> - Amazing cheese shop<br>
                        Browse colorful vintage stores and murals
                    </div>
                    <div class="tip">
                        💡 Many shops close 6-7pm Sundays. Go early! Very walkable, pedestrian-friendly.
                    </div>
                </div>
            </div>

            <!-- STOP 9 -->
            <div class="step" onclick="focusOnMap(9)">
                <div class="step-number">9</div>
                <div class="step-time">⏰ 6:15 - 7:00 PM</div>
                <h3>🏛️ Nathan Phillips Square & City Hall</h3>
                <div class="step-details">
                    <span class="duration">⏱️ 45 min</span>
                    <span class="cost">💰 FREE</span>
                    <p><strong>📍 100 Queen St W (20 min walk, 1.5km)</strong></p>
                    <p>Walk east on Dundas, then south to Queen St. Iconic Toronto sign, reflecting pool, modern architecture!</p>
                    <div class="tip">
                        💡 Great photo ops at the TORONTO sign. Eaton Centre is right next door if you need to shop or use facilities.
                    </div>
                </div>
            </div>

            <!-- STOP 10 -->
            <div class="step" onclick="focusOnMap(10)">
                <div class="step-number">10</div>
                <div class="step-time">⏰ 7:30 - 8:30 PM</div>
                <h3>🌅 Canoe Landing Park</h3>
                <div class="step-details">
                    <span class="duration">⏱️ 45 min</span>
                    <span class="cost">💰 FREE</span>
                    <p><strong>📍 95 Fort York Blvd</strong></p>
                    <div class="transit">
                        🚇 From Dundas Station, take Line 1 south to Union (3 min)<br>
                        Then walk or take 509/510 streetcar west to Fort York
                    </div>
                    <p>Sunset views of CN Tower & waterfront. Red canoe sculptures. Peaceful end to busy day.</p>
                    <div class="food-stop">
                        🍽️ <strong>Dinner Option:</strong> Entertainment District nearby:<br>
                        • <strong>Canoe Restaurant</strong> (upscale Canadian, 54th floor)<br>
                        • <strong>Steam Whistle Brewing</strong> (casual brewery)<br>
                        • <strong>King St W</strong> - dozens of restaurants
                    </div>
                </div>
            </div>

            <div style="margin-top: 30px;">
                <h2 style="color: #667eea; margin-bottom: 20px; font-size: 24px;">📝 Essential Information</h2>
                
                <!-- Weather Section -->
                <div class="info-section">
                    <h3>🌡️ Weather by Season</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <strong>❄️ Winter (Dec-Feb)</strong>
                            -5 to 0°C. Bundle up! Ice skating, holiday markets, snowy charm.
                        </div>
                        <div class="info-item">
                            <strong>🌸 Spring (Mar-May)</strong>
                            5-15°C. Layers needed. Cherry blossoms in April, parks come alive.
                        </div>
                        <div class="info-item">
                            <strong>☀️ Summer (Jun-Aug)</strong>
                            20-30°C. Sunny & humid. Festivals, patios, best outdoor weather!
                        </div>
                        <div class="info-item">
                            <strong>🍂 Fall (Sep-Nov)</strong>
                            10-20°C. Perfect weather. Fall colors peak in October, comfortable walking.
                        </div>
                    </div>
                </div>

                <!-- Money Section -->
                <div class="info-section">
                    <h3>💳 Money Matters</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <strong>Payment Methods</strong>
                            Most places accept credit/debit. Some market vendors prefer cash.
                        </div>
                        <div class="info-item">
                            <strong>Budget Range</strong>
                            Budget: $70-90 | Moderate: $100-150 | Splurge: $200+
                        </div>
                        <div class="info-item">
                            <strong>Tipping Guide</strong>
                            Restaurants: 15-20% | Coffee/Quick service: $1-2 | Taxis: 10-15%
                        </div>
                        <div class="info-item">
                            <strong>ATMs & Exchange</strong>
                            ATMs widely available. Exchange at banks for best rates, not airport.
                        </div>
                    </div>
                </div>

                <!-- Booking Section -->
                <div class="info-section">
                    <h3>🎫 Advance Booking Tips</h3>
                    <div class="info-item">
                        <strong>Book These Online:</strong><br>
                        • CN Tower & Ripley's - Skip lines, save time<br>
                        • ROM - Check for free admission days, book timed tickets<br>
                        • Toronto CityPASS - Save 38% on 5 attractions ($88 adult, $59 child)<br>
                        • EdgeWalk at CN Tower - Book weeks ahead, popular activity
                    </div>
                </div>

                <!-- Apps & Tools Section -->
                <div class="info-section">
                    <h3>📱 Essential Apps & Tools</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <strong>Transit</strong>
                            TTC app (live times), Google Maps (directions), PRESTO card app
                        </div>
                        <div class="info-item">
                            <strong>Attractions</strong>
                            ROM app, CN Tower app (interactive guides & info)
                        </div>
                        <div class="info-item">
                            <strong>Getting Around</strong>
                            Uber, Lyft, Bike Share Toronto app
                        </div>
                        <div class="info-item">
                            <strong>Useful</strong>
                            Weather app, Yelp/Google Reviews for food, OpenTable for reservations
                        </div>
                    </div>
                </div>

                <!-- Facilities Section -->
                <div class="info-section">
                    <h3>🚽 Facilities & Services</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <strong>Restrooms</strong>
                            All attractions, Union Station, Eaton Centre, Harbourfront. Most cafes welcome customers.
                        </div>
                        <div class="info-item">
                            <strong>WiFi</strong>
                            Free at attractions, cafes, Union Station. City of Toronto public WiFi in many areas.
                        </div>
                        <div class="info-item">
                            <strong>Luggage Storage</strong>
                            Union Station lockers, hotel concierge (even if not guest), some attractions
                        </div>
                        <div class="info-item">
                            <strong>Phone/SIM Cards</strong>
                            Major carriers: Rogers, Bell, Telus. Tourist SIM cards at airport, convenience stores
                        </div>
                    </div>
                </div>

                <!-- Best Times Section -->
                <div class="info-section">
                    <h3>🎯 Best Times to Visit</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <strong>Least Crowded</strong>
                            Weekday mornings (except holidays). Early birds get best photos!
                        </div>
                        <div class="info-item">
                            <strong>Special Days</strong>
                            Saturday: Farmers Market 5am-3pm | ROM 3rd Tue free evenings
                        </div>
                        <div class="info-item">
                            <strong>Watch Out</strong>
                            Sunday: Some shops close early. Monday: St. Lawrence Market closed
                        </div>
                        <div class="info-item">
                            <strong>Holidays</strong>
                            Canadian holidays = busier & some closures. Check ahead!
                        </div>
                    </div>
                </div>

                <!-- Safety & Accessibility -->
                <div class="info-section">
                    <h3>♿ Accessibility & Safety</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <strong>Wheelchair Access</strong>
                            All major attractions fully accessible. TTC has elevators. Streets have curb cuts.
                        </div>
                        <div class="info-item">
                            <strong>Safety</strong>
                            Toronto is very safe. Stay aware in crowded areas. Emergency: 911
                        </div>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px; padding: 25px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);">
                <h3 style="margin-bottom: 15px; font-size: 22px;">🍁 Welcome to Jay's Toronto Guide! 🍁</h3>
                <p style="font-size: 14px; line-height: 2; margin-bottom: 15px;">
                    <strong>Your perfect Toronto adventure with real-time navigation!</strong><br>
                    This guide works <strong>year-round</strong> with live features.<br><br>
                    
                    <strong>🎯 REAL-TIME FEATURES:</strong><br>
                    🧭 <strong>Live Turn-by-Turn Navigation</strong> - Track your position in real-time<br>
                    📏 <strong>Distance & Time Updates</strong> - Know exactly how far to next stop<br>
                    ✅ <strong>Auto-Completion</strong> - Checkpoints auto-mark when you arrive<br>
                    🔍 <strong>Nearby Search</strong> - Find restrooms, ATMs, cafes instantly<br>
                    🌤️ <strong>Live Weather</strong> - Current conditions at your fingertips<br>
                    🧭 <strong>AR Compass</strong> - Visual arrow pointing to destination<br>
                    📍 <strong>One-Tap Maps</strong> - Opens in your phone's native maps app<br>
                    🎮 <strong>Gamified Progress</strong> - Track & share your adventure<br><br>
                    
                    <strong>📱 HOW TO USE:</strong><br>
                    1. Tap <strong>📍</strong> button (bottom right) to enable GPS tracking<br>
                    2. Click <strong>🧭 Navigate</strong> on any stop for live directions<br>
                    3. Follow the on-screen navigation panel<br>
                    4. Explore nearby facilities with <strong>🔍</strong> button<br>
                    5. Check weather anytime with <strong>🌤️</strong> button<br><br>
                    
                    <strong>💻 Desktop:</strong> Full interactive experience<br>
                    <strong>📱 Mobile:</strong> GPS navigation + native maps integration<br>
                    <strong>🗺️ Map:</strong> Real-time position + AR compass<br><br>
                    
                    <strong style="font-size: 16px;">Have an unforgettable adventure! 🎉</strong>
                </p>
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.3); font-size: 12px; opacity: 0.9;">
                    Made with ❤️ for Toronto explorers | Real-time GPS Navigation | Works on iOS, Android & Desktop<br>
                    <strong>🔋 Battery Tip:</strong> Enable location only when navigating to save power
                </div>
            </div>
        </div>

        <div id="map"></div>
        
        <!-- Real-time Navigation Panel -->
        <div class="navigation-panel" id="nav-panel">
            <div class="nav-content">
                <div class="nav-icon">🧭</div>
                <div class="nav-info">
                    <p class="nav-distance" id="nav-distance">Calculating...</p>
                    <p class="nav-time" id="nav-time">Getting your location...</p>
                </div>
                <div class="nav-buttons">
                    <button class="nav-btn" onclick="nextStop()">Next Stop →</button>
                    <button class="nav-btn stop" onclick="stopNavigation()">Stop</button>
                </div>
            </div>
        </div>

        <!-- Location Controls -->
        <div class="location-controls">
            <button class="location-btn" id="locate-btn" onclick="toggleTracking()" title="Track my location (T)">
                📍
            </button>
            <button class="location-btn" onclick="findNearby()" title="Find nearby facilities">
                🔍
            </button>
            <button class="location-btn" onclick="toggleWeather()" title="Weather (W)">
                🌤️
            </button>
            <button class="location-btn" onclick="toggleVoice()" title="Voice navigation (V)">
                🔊
            </button>
            <button class="location-btn" onclick="showStats()" title="Your stats">
                📊
            </button>
            <button class="location-btn" onclick="showEmergency()" title="Emergency contacts" style="background: #ff5252; color: white;">
                🚨
            </button>
        </div>

        <!-- Weather Widget -->
        <div class="weather-widget" id="weather-widget">
            <div style="text-align: center;">
                <div id="weather-icon" style="font-size: 32px;">🌤️</div>
                <div id="weather-temp" style="font-size: 18px; font-weight: bold; margin: 5px 0;">--°C</div>
                <div id="weather-desc" style="font-size: 12px; color: #666;">Loading...</div>
            </div>
        </div>

        <!-- Direction Indicator (AR Compass) -->
        <div class="direction-indicator" id="direction-indicator">
            <div class="direction-arrow" id="direction-arrow"></div>
        </div>

        <!-- Toast Notifications -->
        <div class="toast" id="toast"></div>
    </div>

    <script>
        // Initialize map
        const map = L.map('map').setView([43.6532, -79.3832], 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // Store markers for focus function
        const markers = {};

        // Custom numbered icons with gradient (responsive)
        function createNumberIcon(num, color, isTransit = false) {
            const isMobile = window.innerWidth < 768;
            const iconSize = isMobile ? 36 : 40;
            const fontSize = isTransit ? (isMobile ? '18px' : '20px') : (isMobile ? '15px' : '16px');
            const icon = isTransit ? '🚇' : num;
            
            return L.divIcon({
                html: `<div style="background: linear-gradient(135deg, ${color}, ${adjustColor(color, -20)}); width: ${iconSize}px; height: ${iconSize}px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: ${fontSize}; border: 3px solid white; box-shadow: 0 4px 15px rgba(0,0,0,0.3); animation: bounce 2s ease-in-out infinite;">${icon}</div>
                <style>
                @keyframes bounce {
                    0%, 100% { transform: translateY(0); }
                    50% { transform: translateY(-5px); }
                }
                </style>`,
                className: '',
                iconSize: [iconSize, iconSize],
                iconAnchor: [iconSize/2, iconSize],
                popupAnchor: [0, -iconSize]
            });
        }

        function adjustColor(color, amount) {
            return '#' + color.replace(/^#/, '').replace(/../g, color => ('0'+Math.min(255, Math.max(0, parseInt(color, 16) + amount)).toString(16)).substr(-2));
        }

        // Main stops with detailed info
        const stops = [
            { 
                num: 1, name: "CN Tower", lat: 43.6426, lng: -79.3871, 
                color: "#667eea", time: "10:00 AM", 
                info: "Canada's icon! 553m tall, glass floor, 360° views. Book ahead online!"
            },
            { 
                num: 2, name: "Ripley's Aquarium", lat: 43.6424, lng: -79.3860, 
                color: "#1e88e5", time: "11:00 AM",
                info: "20,000 aquatic animals. Underwater tunnel is breathtaking!"
            },
            { 
                num: 3, name: "Union Station", lat: 43.6456, lng: -79.3804, 
                color: "#43a047", time: "12:15 PM",
                info: "Historic transit hub. Food court & PATH underground mall."
            },
            { 
                num: 4, name: "St. Lawrence Market", lat: 43.6487, lng: -79.3715, 
                color: "#fb8c00", time: "12:30 PM",
                info: "World's best food market! Famous peameal bacon sandwich!"
            },
            { 
                num: 5, name: "Distillery District", lat: 43.6503, lng: -79.3596, 
                color: "#e53935", time: "2:00 PM",
                info: "Victorian industrial village. Year-round events & great food!"
            },
            { 
                num: 6, name: "King Station", lat: 43.6490, lng: -79.3778, 
                color: "#00897b", time: "3:30 PM",
                info: "TTC Line 1 (Yellow) northbound to Museum Station.", isTransit: true
            },
            { 
                num: 7, name: "Royal Ontario Museum", lat: 43.6677, lng: -79.3948, 
                color: "#8e24aa", time: "3:50 PM",
                info: "18M+ artifacts! Dinosaurs, mummies, gems. Check for free days!"
            },
            { 
                num: 8, name: "Kensington Market", lat: 43.6540, lng: -79.4022, 
                color: "#d81b60", time: "5:00 PM",
                info: "Bohemian neighborhood. Best tacos, vintage shops, street art!"
            },
            { 
                num: 9, name: "Nathan Phillips Square", lat: 43.6525, lng: -79.3839, 
                color: "#5e35b1", time: "6:15 PM",
                info: "TORONTO sign! City Hall. Ice skating in winter!"
            },
            { 
                num: 10, name: "Canoe Landing Park", lat: 43.6377, lng: -79.3971, 
                color: "#00acc1", time: "7:30 PM",
                info: "Waterfront views. Red canoe sculptures. Peaceful ending!"
            }
        ];

        // Additional transit waypoints
        const transitWaypoints = [
            { name: "Museum Station", lat: 43.6676, lng: -79.3937, type: "metro", line: "Line 1 (Yellow)" },
            { name: "Dundas Station", lat: 43.6563, lng: -79.3805, type: "metro", line: "Line 1 (Yellow)" }
        ];

        // Add main stop markers with enhanced popups
        stops.forEach(stop => {
            const isMobile = window.innerWidth < 768;
            const popupWidth = isMobile ? 180 : 220;
            
            const marker = L.marker([stop.lat, stop.lng], { 
                icon: createNumberIcon(stop.num, stop.color, stop.isTransit)
            })
            .bindPopup(`
                <div style="font-family: Arial; min-width: ${popupWidth}px;">
                    <h3 style="margin: 0 0 8px 0; color: white; font-size: ${isMobile ? '14px' : '16px'};">
                        ${stop.isTransit ? '🚇' : stop.num + '.'} ${stop.name}
                    </h3>
                    <p style="margin: 5px 0; font-size: ${isMobile ? '12px' : '13px'};"><strong>⏰ ${stop.time}</strong></p>
                    <p style="margin: 5px 0; font-size: ${isMobile ? '11px' : '12px'}; line-height: 1.5;">${stop.info}</p>
                </div>
            `, { 
                className: 'custom-popup',
                maxWidth: popupWidth + 20,
                closeButton: true
            })
            .addTo(map);
            
            markers[stop.num] = marker;
        });

        // Add transit station markers
        transitWaypoints.forEach(wp => {
            const isMobile = window.innerWidth < 768;
            const iconSize = isMobile ? 24 : 28;
            
            const icon = L.divIcon({
                html: `<div style="background: #00897b; width: ${iconSize}px; height: ${iconSize}px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: ${isMobile ? '14px' : '16px'}; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">Ⓜ️</div>`,
                className: '',
                iconSize: [iconSize, iconSize],
                iconAnchor: [iconSize/2, iconSize/2]
            });
            
            L.marker([wp.lat, wp.lng], { icon })
                .bindPopup(`<strong style="font-size: ${isMobile ? '12px' : '14px'};">${wp.name}</strong><br><span style="font-size: ${isMobile ? '11px' : '12px'};">${wp.line}</span>`)
                .addTo(map);
        });

        // Detailed walking routes with waypoints
        const isMobile = window.innerWidth < 768;
        const routeWeight = isMobile ? 4 : 5;
        const dashArray = isMobile ? '8, 6' : '10, 8';
        
        const walkingRoutes = [
            {
                name: "CN Tower → Aquarium",
                coords: [[43.6426, -79.3871], [43.6424, -79.3860]],
                color: "#667eea",
                distance: "150m",
                time: "2 min"
            },
            {
                name: "Aquarium → Union",
                coords: [
                    [43.6424, -79.3860],
                    [43.6432, -79.3850],
                    [43.6445, -79.3820],
                    [43.6456, -79.3804]
                ],
                color: "#667eea",
                distance: "600m",
                time: "8 min"
            },
            {
                name: "Union → St. Lawrence",
                coords: [
                    [43.6456, -79.3804],
                    [43.6465, -79.3775],
                    [43.6475, -79.3740],
                    [43.6487, -79.3715]
                ],
                color: "#fb8c00",
                distance: "850m",
                time: "10 min"
            },
            {
                name: "Market → Distillery",
                coords: [
                    [43.6487, -79.3715],
                    [43.6490, -79.3680],
                    [43.6495, -79.3640],
                    [43.6503, -79.3596]
                ],
                color: "#fb8c00",
                distance: "750m",
                time: "10 min"
            },
            {
                name: "Distillery → King Station",
                coords: [
                    [43.6503, -79.3596],
                    [43.6495, -79.3650],
                    [43.6490, -79.3720],
                    [43.6490, -79.3778]
                ],
                color: "#00897b",
                distance: "450m",
                time: "5 min"
            },
            {
                name: "Museum → Kensington",
                coords: [
                    [43.6677, -79.3948],
                    [43.6670, -79.3985],
                    [43.6600, -79.4010],
                    [43.6540, -79.4022]
                ],
                color: "#8e24aa",
                distance: "1.2km",
                time: "15 min"
            },
            {
                name: "Kensington → Nathan Phillips",
                coords: [
                    [43.6540, -79.4022],
                    [43.6545, -79.3950],
                    [43.6555, -79.3880],
                    [43.6525, -79.3839]
                ],
                color: "#d81b60",
                distance: "1.5km",
                time: "20 min"
            }
        ];

        // Draw walking routes with labels
        walkingRoutes.forEach((route, index) => {
            const polyline = L.polyline(route.coords, {
                color: route.color,
                weight: routeWeight,
                opacity: 0.7,
                dashArray: dashArray,
                lineCap: 'round'
            }).addTo(map);
            
            const popupContent = `
                <strong style="font-size: ${isMobile ? '12px' : '14px'};">🚶 ${route.name}</strong><br>
                <span style="font-size: ${isMobile ? '11px' : '12px'};">
                Distance: ${route.distance}<br>
                Time: ${route.time}
                </span>
            `;
            polyline.bindPopup(popupContent);

            // Add animated dots along path
            const decorator = L.polyline(route.coords, {
                color: route.color,
                weight: 2,
                opacity: 0.5,
                dashArray: '1, 20'
            }).addTo(map);
        });

        // Transit route (subway)
        const subwayRoute = [
            [43.6490, -79.3778], // King Station
            [43.6510, -79.3795], // Waypoint
            [43.6530, -79.3810], // Queen
            [43.6563, -79.3805], // Dundas
            [43.6600, -79.3820], // Waypoint
            [43.6640, -79.3880], // Waypoint
            [43.6676, -79.3937]  // Museum Station
        ];

        L.polyline(subwayRoute, {
            color: '#00897b',
            weight: isMobile ? 5 : 6,
            opacity: 0.9,
            lineCap: 'round'
        }).bindPopup(`
            <div style="font-size: ${isMobile ? '12px' : '14px'};">
                <strong>🚇 TTC Line 1 (Yellow)</strong><br>
                King → Museum Station<br>
                5 stops, ~8 minutes<br>
                Cost: $3.35
            </div>
        `).addTo(map);

        // Enhanced legend with mobile toggle
        const legend = L.control({position: 'topright'});
        legend.onAdd = function() {
            const div = L.DomUtil.create('div', 'map-legend');
            const isMobile = window.innerWidth < 768;
            
            if (isMobile) {
                div.style.cursor = 'pointer';
                let isExpanded = false;
                
                const updateContent = () => {
                    if (isExpanded) {
                        div.innerHTML = `
                            <h4>🗺️ Jay's Toronto Guide <span style="float: right;">▼</span></h4>
                            <div class="legend-item">
                                <div class="legend-icon" style="background: #667eea;">1-2</div>
                                <span>Morning</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-icon" style="background: #fb8c00;">3-5</div>
                                <span>Markets</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-icon" style="background: #8e24aa;">6-7</div>
                                <span>Museum</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-icon" style="background: #d81b60;">8-9</div>
                                <span>Evening</span>
                            </div>
                            <hr style="margin: 8px 0; border: none; border-top: 1px solid #ddd;">
                            <div class="legend-item">
                                <div class="legend-line" style="background: #667eea; border: 2px dashed #667eea;"></div>
                                <span>Walk</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-line" style="background: #00897b;"></div>
                                <span>Subway</span>
                            </div>
                        `;
                    } else {
                        div.innerHTML = `<h4>🗺️ Legend <span style="float: right;">▶</span></h4>`;
                    }
                };
                
                updateContent();
                
                div.onclick = function() {
                    isExpanded = !isExpanded;
                    updateContent();
                };
            } else {
                div.innerHTML = `
                    <h4>🗺️ Jay's Toronto Guide</h4>
                    <div class="legend-item">
                        <div class="legend-icon" style="background: #667eea;">1-2</div>
                        <span>Morning Attractions</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon" style="background: #fb8c00;">3-5</div>
                        <span>Lunch & Markets</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon" style="background: #8e24aa;">6-7</div>
                        <span>Transit & Museum</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-icon" style="background: #d81b60;">8-9</div>
                        <span>Evening Exploration</span>
                    </div>
                    <hr style="margin: 10px 0; border: none; border-top: 1px solid #ddd;">
                    <div class="legend-item">
                        <div class="legend-line" style="background: #667eea; border: 2px dashed #667eea;"></div>
                        <span>Walking Route</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-line" style="background: #00897b;"></div>
                        <span>TTC Subway</span>
                    </div>
                    <div class="legend-item">
                        <span style="margin-right: 10px;">Ⓜ️</span>
                        <span>Metro Station</span>
                    </div>
                `;
            }
            return div;
        };
        legend.addTo(map);

        // Cross-platform maps integration
        window.openInMaps = function(lat, lng, name) {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            const encodedName = encodeURIComponent(name);
            
            // Detect iOS
            if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                // Try Apple Maps first
                window.location.href = `maps://maps.apple.com/?q=${encodedName}&ll=${lat},${lng}`;
                // Fallback to Google Maps if Apple Maps doesn't open
                setTimeout(() => {
                    window.open(`https://maps.google.com/?q=${lat},${lng}`, '_blank');
                }, 500);
            }
            // Detect Android
            else if (/android/i.test(userAgent)) {
                window.location.href = `geo:${lat},${lng}?q=${lat},${lng}(${encodedName})`;
            }
            // Desktop or other devices
            else {
                window.open(`https://www.google.com/maps/search/?api=1&query=${lat},${lng}&query_place_id=${encodedName}`, '_blank');
            }
        };

        // Get directions between two points
        window.getDirections = function(fromLat, fromLng, toLat, toLng) {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            
            // Detect iOS
            if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                window.location.href = `maps://maps.apple.com/?saddr=${fromLat},${fromLng}&daddr=${toLat},${toLng}&dirflg=w`;
                setTimeout(() => {
                    window.open(`https://www.google.com/maps/dir/${fromLat},${fromLng}/${toLat},${toLng}`, '_blank');
                }, 500);
            }
            // Detect Android
            else if (/android/i.test(userAgent)) {
                window.location.href = `google.navigation:q=${toLat},${toLng}`;
            }
            // Desktop or other devices
            else {
                window.open(`https://www.google.com/maps/dir/${fromLat},${fromLng}/${toLat},${toLng}`, '_blank');
            }
        };

        // Focus function with responsive zoom
        window.focusOnMap = function(num) {
            const marker = markers[num];
            if (marker) {
                const isMobile = window.innerWidth < 768;
                const zoomLevel = isMobile ? 15 : 16;
                map.setView(marker.getLatLng(), zoomLevel, { 
                    animate: true,
                    duration: 0.8
                });
                setTimeout(() => marker.openPopup(), 500);
                
                // Scroll to map on mobile
                if (isMobile) {
                    document.getElementById('map').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }
            }
        };

        // Add scale (responsive position)
        const scalePosition = window.innerWidth < 768 ? 'bottomleft' : 'bottomleft';
        L.control.scale({ 
            imperial: false, 
            metric: true,
            position: scalePosition,
            maxWidth: window.innerWidth < 768 ? 100 : 150
        }).addTo(map);

        // Add recenter button for mobile
        if (window.innerWidth < 768) {
            const recenterControl = L.control({ position: 'topleft' });
            recenterControl.onAdd = function() {
                const button = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                button.innerHTML = '<a href="#" style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; font-size: 20px; text-decoration: none; background: white; color: #667eea;" title="Recenter map">🎯</a>';
                button.onclick = function(e) {
                    e.preventDefault();
                    map.fitBounds(bounds, { padding: [30, 30], animate: true });
                };
                return button;
            };
            recenterControl.addTo(map);
        }

        // Fit all markers on load with responsive padding
        const bounds = L.latLngBounds(stops.map(s => [s.lat, s.lng]));
        const padding = window.innerWidth < 768 ? [30, 30] : [50, 50];
        map.fitBounds(bounds, { padding: padding });

        // Handle window resize
        let resizeTimer;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function() {
                map.invalidateSize();
                const newPadding = window.innerWidth < 768 ? [30, 30] : [50, 50];
                map.fitBounds(bounds, { padding: newPadding });
            }, 250);
        });

        // Disable scroll zoom on mobile to prevent accidental zooming
        if (window.innerWidth < 768) {
            map.scrollWheelZoom.disable();
            // Enable zoom on click
            map.on('click', function() {
                if (!map.scrollWheelZoom.enabled()) {
                    map.scrollWheelZoom.enable();
                    setTimeout(() => {
                        map.scrollWheelZoom.disable();
                    }, 3000);
                }
            });
        }

        // Progress tracker functionality
        let completedStops = new Set();
        
        window.toggleCheckpoint = function(stopNum) {
            const checkpoint = document.querySelector(`[data-stop="${stopNum}"]`);
            if (completedStops.has(stopNum)) {
                completedStops.delete(stopNum);
                checkpoint.classList.remove('completed');
            } else {
                completedStops.add(stopNum);
                checkpoint.classList.add('completed');
            }
            updateProgress();
        };

        function updateProgress() {
            const total = 10;
            const completed = completedStops.size;
            const percentage = (completed / total) * 100;
            
            document.getElementById('progress-bar').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = `${completed} of ${total} stops completed`;
            document.getElementById('progress-percent').textContent = Math.round(percentage) + '%';
            
            // Celebration animation when all completed
            if (completed === total) {
                confetti();
            }
        }

        // Simple confetti effect
        function confetti() {
            const text = document.getElementById('progress-text');
            text.textContent = '🎉 Amazing! You completed Jay\'s Toronto Guide! 🎉';
            text.style.color = '#667eea';
            text.style.fontWeight = 'bold';
        }

        // Share functionality
        window.shareGuide = async function() {
            const shareData = {
                title: 'Jay\'s Toronto Guide',
                text: 'Check out this amazing Toronto day trip guide with interactive maps and directions!',
                url: window.location.href
            };
            
            try {
                if (navigator.share) {
                    await navigator.share(shareData);
                } else {
                    // Fallback: copy to clipboard
                    await navigator.clipboard.writeText(window.location.href);
                    alert('✅ Link copied to clipboard! Share it with your friends!');
                }
            } catch (err) {
                console.log('Share failed:', err);
            }
        };

        // Download for offline use
        window.downloadOffline = function() {
            alert('📥 Offline Mode Tips:\n\n1. Use your browser\'s "Save Page As" to download this guide\n2. Take screenshots of the map for offline reference\n3. Download Google Maps offline area for Toronto\n4. Save key addresses in your phone\'s notes\n\nOr simply print this page to PDF using the Print button!');
        };

        // ========================================
        // REAL-TIME NAVIGATION FEATURES
        // ========================================

        let userMarker = null;
        let userLocation = null;
        let watchId = null;
        let isTracking = false;
        let currentStopIndex = 0;
        let navigationActive = false;
        let userHeading = 0;
        let accuracyCircle = null;

        // Initialize geolocation tracking
        window.toggleTracking = function() {
            if (!isTracking) {
                startTracking();
            } else {
                stopTracking();
            }
        };

        function startTracking() {
            if (!navigator.geolocation) {
                showToast('❌ Geolocation not supported by your browser');
                return;
            }

            const locateBtn = document.getElementById('locate-btn');
            locateBtn.classList.add('active');
            isTracking = true;

            // Get initial position
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    updateUserLocation(position);
                    showToast('✅ Location tracking enabled');
                },
                (error) => {
                    console.error('Location error:', error);
                    showToast('❌ Could not get your location');
                    stopTracking();
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );

            // Watch position continuously
            watchId = navigator.geolocation.watchPosition(
                updateUserLocation,
                (error) => console.error('Watch error:', error),
                { enableHighAccuracy: true, maximumAge: 1000 }
            );

            // Start device orientation (compass)
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', handleOrientation);
            }
        }

        function stopTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            if (userMarker) {
                map.removeLayer(userMarker);
                userMarker = null;
            }

            if (accuracyCircle) {
                map.removeLayer(accuracyCircle);
                accuracyCircle = null;
            }

            const locateBtn = document.getElementById('locate-btn');
            locateBtn.classList.remove('active');
            isTracking = false;

            window.removeEventListener('deviceorientation', handleOrientation);
            showToast('Location tracking stopped');
        }

        function updateUserLocation(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;

            userLocation = { lat, lng };

            // Create or update user marker
            if (!userMarker) {
                const userIcon = L.divIcon({
                    html: `<div style="width: 20px; height: 20px; background: #4285f4; border: 3px solid white; border-radius: 50%; box-shadow: 0 0 10px rgba(66,133,244,0.5);"></div>`,
                    className: '',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });
                userMarker = L.marker([lat, lng], { icon: userIcon }).addTo(map);
                
                // Center map on user
                map.setView([lat, lng], 15, { animate: true });
            } else {
                userMarker.setLatLng([lat, lng]);
            }

            // Update accuracy circle
            if (accuracyCircle) {
                map.removeLayer(accuracyCircle);
            }
            accuracyCircle = L.circle([lat, lng], {
                radius: accuracy,
                color: '#4285f4',
                fillColor: '#4285f4',
                fillOpacity: 0.1,
                weight: 1
            }).addTo(map);

            // Update navigation if active
            if (navigationActive) {
                updateNavigation();
            }
        }

        function handleOrientation(event) {
            if (event.alpha !== null) {
                userHeading = event.alpha;
                updateDirectionArrow();
            }
        }

        // Start navigation to next stop
        window.startNavigation = function(stopIndex) {
            if (!isTracking) {
                showToast('📍 Enable location tracking first!');
                toggleTracking();
                return;
            }

            currentStopIndex = stopIndex || 0;
            navigationActive = true;
            document.getElementById('nav-panel').classList.add('active');
            
            updateNavigation();
            showToast('🧭 Navigation started!');
        };

        window.stopNavigation = function() {
            navigationActive = false;
            document.getElementById('nav-panel').classList.remove('active');
            document.getElementById('direction-indicator').classList.remove('active');
            showToast('Navigation stopped');
        };

        window.nextStop = function() {
            if (currentStopIndex < stops.length - 1) {
                currentStopIndex++;
                updateNavigation();
                focusOnMap(currentStopIndex + 1);
                showToast(`Next: ${stops[currentStopIndex].name}`);
            } else {
                showToast('🎉 You\'ve reached the final stop!');
                stopNavigation();
            }
        };

        function updateNavigation() {
            if (!userLocation || !navigationActive) return;

            const targetStop = stops[currentStopIndex];
            const distance = calculateDistance(
                userLocation.lat, userLocation.lng,
                targetStop.lat, targetStop.lng
            );

            const distanceText = distance < 1 
                ? `${Math.round(distance * 1000)}m away` 
                : `${distance.toFixed(2)}km away`;

            const walkingTime = Math.round((distance / 5) * 60); // 5 km/h walking speed
            const timeText = walkingTime < 60 
                ? `~${walkingTime} min walk` 
                : `~${Math.round(walkingTime / 60)}h ${walkingTime % 60}m walk`;

            document.getElementById('nav-distance').textContent = distanceText;
            document.getElementById('nav-time').textContent = `To ${targetStop.name} • ${timeText}`;

            // Voice updates at specific distances
            const distanceMeters = distance * 1000;
            if (voiceEnabled) {
                if (distanceMeters < 50 && lastAnnouncedDistance >= 50) {
                    speakNavigation(`Arriving at ${targetStop.name}`);
                    lastAnnouncedDistance = distanceMeters;
                } else if (distanceMeters < 200 && lastAnnouncedDistance >= 200) {
                    speakNavigation(`200 meters to ${targetStop.name}`);
                    lastAnnouncedDistance = distanceMeters;
                } else if (distanceMeters < 500 && lastAnnouncedDistance >= 500) {
                    speakNavigation(`500 meters ahead`);
                    lastAnnouncedDistance = distanceMeters;
                }
            }

            // Auto-complete if within 50m
            if (distanceMeters < 50) {
                showToast(`🎉 You've arrived at ${targetStop.name}!`);
                if (!completedStops.has(currentStopIndex + 1)) {
                    toggleCheckpoint(currentStopIndex + 1);
                }
                if (voiceEnabled) {
                    speakNavigation(`You have arrived at ${targetStop.name}. Enjoy your visit!`);
                }
            }

            updateDirectionArrow();
        }

        function updateDirectionArrow() {
            if (!userLocation || !navigationActive) return;

            const targetStop = stops[currentStopIndex];
            const bearing = calculateBearing(
                userLocation.lat, userLocation.lng,
                targetStop.lat, targetStop.lng
            );

            const arrow = document.getElementById('direction-arrow');
            const rotation = bearing - userHeading;
            arrow.style.transform = `rotate(${rotation}deg)`;
            
            document.getElementById('direction-indicator').classList.add('active');
        }

        // Calculate distance between two points (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function calculateBearing(lat1, lon1, lat2, lon2) {
            const dLon = toRad(lon2 - lon1);
            const y = Math.sin(dLon) * Math.cos(toRad(lat2));
            const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
                     Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(dLon);
            const bearing = Math.atan2(y, x);
            return (toDeg(bearing) + 360) % 360;
        }

        function toRad(degrees) {
            return degrees * Math.PI / 180;
        }

        function toDeg(radians) {
            return radians * 180 / Math.PI;
        }

        // Find nearby facilities
        window.findNearby = function() {
            if (!userLocation) {
                showToast('📍 Enable location tracking first!');
                toggleTracking();
                return;
            }

            const facilities = [
                { name: 'Nearest Restroom', icon: '🚽', type: 'restroom' },
                { name: 'Coffee Shop', icon: '☕', type: 'cafe' },
                { name: 'Restaurant', icon: '🍽️', type: 'restaurant' },
                { name: 'ATM', icon: '💳', type: 'atm' },
                { name: 'Pharmacy', icon: '💊', type: 'pharmacy' }
            ];

            let html = '<div class="nearby-panel"><h4 style="margin: 0 0 10px 0; color: #667eea;">Nearby Facilities</h4>';
            
            facilities.forEach(facility => {
                html += `
                    <div class="nearby-item" onclick="searchNearby('${facility.type}')">
                        <span style="font-size: 24px;">${facility.icon}</span>
                        <span style="flex: 1;">${facility.name}</span>
                        <span style="color: #667eea;">Search →</span>
                    </div>
                `;
            });
            
            html += '</div>';

            showToast('Searching nearby facilities...');
            // In a real app, this would use Google Places API
            alert(html.replace(/<[^>]*>/g, '\n')); // Simple fallback
        };

        window.searchNearby = function(type) {
            if (!userLocation) return;
            
            const query = `${type} near ${userLocation.lat},${userLocation.lng}`;
            window.open(`https://www.google.com/maps/search/${encodeURIComponent(query)}`, '_blank');
        };

        // Weather widget
        window.toggleWeather = async function() {
            const widget = document.getElementById('weather-widget');
            
            if (widget.classList.contains('show')) {
                widget.classList.remove('show');
                return;
            }

            widget.classList.add('show');

            // Fetch weather (using open-meteo.com - no API key needed)
            try {
                const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=43.65&longitude=-79.38&current_weather=true`);
                const data = await response.json();
                
                const temp = Math.round(data.current_weather.temperature);
                const weatherCode = data.current_weather.weathercode;
                
                const weatherIcons = {
                    0: '☀️', 1: '🌤️', 2: '⛅', 3: '☁️',
                    45: '🌫️', 48: '🌫️',
                    51: '🌦️', 53: '🌧️', 55: '🌧️',
                    61: '🌧️', 63: '🌧️', 65: '🌧️',
                    71: '🌨️', 73: '🌨️', 75: '🌨️',
                    80: '🌦️', 81: '🌧️', 82: '⛈️',
                    95: '⛈️', 96: '⛈️', 99: '⛈️'
                };

                const weatherDescs = {
                    0: 'Clear', 1: 'Mostly Clear', 2: 'Partly Cloudy', 3: 'Cloudy',
                    45: 'Foggy', 48: 'Foggy',
                    51: 'Light Rain', 53: 'Rain', 55: 'Heavy Rain',
                    61: 'Light Rain', 63: 'Rain', 65: 'Heavy Rain',
                    71: 'Light Snow', 73: 'Snow', 75: 'Heavy Snow',
                    80: 'Showers', 81: 'Rain Showers', 82: 'Heavy Showers',
                    95: 'Thunderstorm', 96: 'Storm', 99: 'Severe Storm'
                };

                document.getElementById('weather-icon').textContent = weatherIcons[weatherCode] || '🌤️';
                document.getElementById('weather-temp').textContent = `${temp}°C`;
                document.getElementById('weather-desc').textContent = weatherDescs[weatherCode] || 'Clear';
            } catch (error) {
                document.getElementById('weather-desc').textContent = 'Unable to load';
            }
        };

        // AR Compass toggle
        window.toggleAR = function() {
            const indicator = document.getElementById('direction-indicator');
            
            if (!navigationActive) {
                showToast('🧭 Start navigation first!');
                return;
            }

            if (indicator.classList.contains('active')) {
                indicator.classList.remove('active');
                showToast('AR Compass disabled');
            } else {
                indicator.classList.add('active');
                showToast('AR Compass enabled');
            }
        };

        // Toast notification
        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        // Add navigation buttons to each step
        stops.forEach((stop, index) => {
            const marker = markers[index + 1];
            if (marker) {
                const originalPopup = marker.getPopup();
                const originalContent = originalPopup.getContent();
                
                const newContent = originalContent + `
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.3);">
                        <button onclick="event.stopPropagation(); startNavigation(${index})" 
                                style="background: linear-gradient(135deg, #4caf50, #388e3c); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; width: 100%;">
                            🧭 Navigate Here
                        </button>
                    </div>
                `;
                
                marker.setPopupContent(newContent);
            }
        });

        // Auto-start navigation on first location
        setTimeout(() => {
            if (isTracking && !navigationActive) {
                const shouldStart = confirm('🧭 Start navigation to the first stop (CN Tower)?');
                if (shouldStart) {
                    startNavigation(0);
                }
            }
        }, 2000);

        // ========================================
        // ADDITIONAL FEATURES
        // ========================================

        // Quick Tour Mode - Optimized 6-hour route
        window.startQuickTour = function() {
            const quickStops = [1, 2, 4, 5, 7, 9]; // CN Tower, Aquarium, Market, Distillery, ROM, Nathan Phillips
            const message = `⚡ QUICK TOUR MODE (6 hours)\n\nOptimized route hitting top 6 attractions:\n\n1. CN Tower (1h)\n2. Ripley's Aquarium (1h)\n3. St. Lawrence Market lunch (45min)\n4. Distillery District (45min)\n5. ROM (1.5h)\n6. Nathan Phillips Square (30min)\n\nTotal: ~6 hours + travel time\n\nWould you like to start this tour?`;
            
            if (confirm(message)) {
                showToast('⚡ Quick Tour Mode activated!');
                if (!isTracking) {
                    toggleTracking();
                }
                setTimeout(() => startNavigation(0), 1000);
            }
        };

        // Voice Navigation (Web Speech API)
        let voiceEnabled = false;
        let lastAnnouncedDistance = 1000; // Start high so first announcement triggers

        function speakNavigation(text) {
            if (!voiceEnabled || !('speechSynthesis' in window)) return;
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            utterance.pitch = 1;
            utterance.volume = 0.8;
            speechSynthesis.speak(utterance);
        }

        // Toggle voice navigation
        window.toggleVoice = function() {
            voiceEnabled = !voiceEnabled;
            const btn = document.querySelector('[onclick="toggleVoice()"]');
            
            if (voiceEnabled) {
                if (btn) btn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                if (btn) btn.style.color = 'white';
                showToast('🔊 Voice navigation enabled');
                speakNavigation('Voice navigation enabled');
            } else {
                if (btn) btn.style.background = 'white';
                if (btn) btn.style.color = 'black';
                showToast('🔇 Voice navigation disabled');
                speechSynthesis.cancel(); // Stop any ongoing speech
            }
        };

        // Battery saver mode
        let batterySaverMode = false;

        window.toggleBatterySaver = function() {
            batterySaverMode = !batterySaverMode;
            
            if (batterySaverMode) {
                // Reduce update frequency
                if (watchId) {
                    navigator.geolocation.clearWatch(watchId);
                    watchId = navigator.geolocation.watchPosition(
                        updateUserLocation,
                        (error) => console.error('Watch error:', error),
                        { enableHighAccuracy: false, maximumAge: 5000 }
                    );
                }
                showToast('🔋 Battery saver mode ON - Updates every 5s');
            } else {
                // Normal frequency
                if (watchId) {
                    navigator.geolocation.clearWatch(watchId);
                    watchId = navigator.geolocation.watchPosition(
                        updateUserLocation,
                        (error) => console.error('Watch error:', error),
                        { enableHighAccuracy: true, maximumAge: 1000 }
                    );
                }
                showToast('⚡ Battery saver mode OFF - Real-time updates');
            }
        };

        // Route replay for completed journey
        window.replayJourney = function() {
            if (completedStops.size === 0) {
                showToast('Complete some stops first!');
                return;
            }
            
            showToast('📹 Journey replay coming soon!');
            // In full version, would animate through all completed stops
        };

        // Emergency contacts
        window.showEmergency = function() {
            alert('🚨 EMERGENCY CONTACTS - Toronto\n\n' +
                  '🚑 Emergency: 911\n' +
                  '👮 Police Non-Emergency: 416-808-2222\n' +
                  '🏥 Telehealth Ontario: 1-866-797-0000\n' +
                  '🦷 Dental Emergency: 416-485-7121\n' +
                  '🚕 Safe Taxi: 416-777-9222\n\n' +
                  'Tourist Information: 416-203-2600\n' +
                  'Lost & Found TTC: 416-393-4100');
        };

        // Stats and achievements
        window.showStats = function() {
            const totalDistance = 4.9;
            const completedDistance = (completedStops.size / 10) * totalDistance;
            const calories = Math.round(completedDistance * 120); // ~120 cal/km walking
            
            alert(`📊 YOUR TORONTO ADVENTURE\n\n` +
                  `✅ Completed: ${completedStops.size} / 10 stops\n` +
                  `🚶 Distance: ${completedDistance.toFixed(1)} / ${totalDistance} km\n` +
                  `🔥 Calories: ${calories} kcal\n` +
                  `⏱️ Time: ~${completedStops.size * 1.5}h / 10h\n` +
                  `📸 Photos taken: Ready to share!\n\n` +
                  `Keep exploring! 🍁`);
        };

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // T = Toggle tracking
            if (e.key === 't' || e.key === 'T') {
                toggleTracking();
            }
            // N = Next stop
            if (e.key === 'n' || e.key === 'N') {
                if (navigationActive) nextStop();
            }
            // S = Stop navigation
            if (e.key === 's' || e.key === 'S') {
                if (navigationActive) stopNavigation();
            }
            // W = Weather
            if (e.key === 'w' || e.key === 'W') {
                toggleWeather();
            }
            // V = Voice
            if (e.key === 'v' || e.key === 'V') {
                toggleVoice();
            }
        });

        // Initialize on load
        console.log('🎉 Jay\'s Toronto Guide loaded!\n' +
                    'Keyboard shortcuts:\n' +
                    'T = Toggle tracking\n' +
                    'N = Next stop\n' +
                    'S = Stop navigation\n' +
                    'W = Weather\n' +
                    'V = Voice navigation');
        
        // Prompt for location on mobile
        if (window.innerWidth < 768) {
            setTimeout(() => {
                if (!isTracking) {
                    const enable = confirm('📍 Enable GPS tracking for real-time navigation?\n\nYou can also enable it anytime by tapping the 📍 button.');
                    if (enable) {
                        toggleTracking();
                    }
                }
            }, 1500);
        }

        // Load saved progress from localStorage (browser-dependent)
        // Note: Progress saving works when page is saved/bookmarked locally
        try {
            const saved = localStorage.getItem('torontoGuideProgress');
            if (saved) {
                const savedStops = JSON.parse(saved);
                savedStops.forEach(stop => {
                    completedStops.add(stop);
                    const checkpoint = document.querySelector(`[data-stop="${stop}"]`);
                    if (checkpoint) checkpoint.classList.add('completed');
                });
                updateProgress();
            }
        } catch (e) {
            // localStorage not available in this environment
            console.log('Progress saving unavailable in artifact view. Save page locally to enable.');
        }

        // Save progress when checkpoints change
        window.addEventListener('beforeunload', function() {
            try {
                localStorage.setItem('torontoGuideProgress', JSON.stringify([...completedStops]));
            } catch (e) {
                // localStorage not available
            }
        });
    </script>
</body>
</html>
